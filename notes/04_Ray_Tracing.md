# 4 光线追踪

计算机图形学的一个基本任务是渲染三维图像：获取由排列在 3D 空间中的多个几何对象组成的场景或模型，并生成从特定视点观察到的对象的 2D 图像。这与几个世纪以来建筑师和工程师通过绘制图纸来将他们的设计传达给其他人的做法相同。

从根本上讲，渲染是将一组对象作为输入并生成一个像素阵列作为输出的过程。不管怎样，渲染涉及考虑每个对象如何影响每个像素； 它可以用两种常规的方式来组织。在对象顺序渲染中，每个对象被依次考虑，并且对于每个对象，它影响的所有像素都被找到并更新。在图像顺序渲染中，每个像素被依次考虑，并且对于每个像素，所有影响它的对象都会被找到并且用于计算像素值。你可以思考循环嵌套的差别：在图像顺序渲染中，每个像素在外部进行循环，而在对象顺序循环中，每个对象在外部进行循环。

图像顺序渲染和对象顺序渲染可以计算出完全相同的图像，但它们适用于计算不同类型的效果，并具有完全不同的性能特征。在我们讨论了这两种方法之后，我们将在 Chapter 8 中探讨它们的比较优劣，但总的来说，图像顺序渲染更容易实现，并且能够产生更多的效果，但通常（虽然不总是）需要比另一种方法更长的执行时间来生成一张可比较的图像。

光线追踪是用于制作三维场景渲染的图像顺序算法，我们将首先考虑它，因为可以在不学习用于基于对象顺序渲染的数学工具的情况下实现光线追踪器的功能。

## 4.1 基本的光线追踪算法

光线追踪器逐个计算每个像素，对于每个像素，基本任务是找到图像中在该像素位置能被看到的对象。每个像素“看”的方向不同，任何像素所看到的物体都必须与视角光线相交，这是一条从视点向像素方向发射的线。我们想要的特定物体是与视角光线相交距离最近的物体，因为它挡住了它后面的任何其他物体的视野。一旦找到了该物体，一个着色计算器使用交点、表面法线和其他信息（取决于所需的渲染类型）来确定像素的颜色。这在 Figure 4.1 中显示，其中光线与两个三角形相交，但只有第一个三角形 $T_2$ 被着色。

::: center
![](../images/4_1.png)
**Figure 4.1.** 这光线被“追踪”到场景中，并且第一个被撞到的物体就是通过该像素看到的物体。在这种情况下，返回的是三角形 $T_2$。
:::

因此，一个基本的光线追踪器由三部分组成：

1. 光线生成，根据相机的几何信息计算出每个像素的视角光线的起点和方向；
2. 光线相交，找到与视角光线相交的最近物体；
3. 着色，根据光线相交的结果计算像素的颜色。

光线追踪程序的基本结构如下：

```
for each pixel do
    compute viewing ray
    ﬁnd ﬁrst object hit by ray and its surface normal n
    set pixel color to value computed from hit point, light, and n
```

本章介绍了用于光线生成、光线相交和着色的基本方法，这些方法足以实现一个简单的演示光线追踪器。对于一个真正有用的系统，需要添加 Chapter 12 中更高效的光线相交技术，并使用 Chapter 10 中更高级的着色方法和 Chapter 13 中的其他渲染技术，才能发挥光线追踪器的真正潜力。

## 4.2 透视

在计算机出现的数百年之前，艺术家们就已经研究了用二维图像或绘画来表现三维物体或场景的问题。照片也通过二维图像来表现三维场景。虽然有很多非传统的制图方法，例如立体主义绘画、鱼眼镜头（Figure 4.2）和外围摄像头，但对于艺术、摄影以及计算机图形学而言，标准的方法是线性透视，即将三维物体投射到图像平面上，使得场景中的直线变为图像中的直线。

::: center
![](../images/4_2.png)
**Figure 4.2.** 使用鱼眼镜头拍摄的图像不是线性透视图像。图片由 Philip Greenspun 提供。
:::

最简单的投影类型是平行投影，其中3D点沿着投影方向移动，直到它们碰到图像平面，将它们映射到2D平面上（Figures 4.3–4.4)）。产生的视图由投影方向和图像平面的选择决定。如果图像平面与视图方向垂直，则投影称为正交投影；否则称为斜投影。

::: center
![](../images/4_3.png)
**Figure 4.3.** 当投影线相互平行并垂直于图像平面时，所得到的视图被称为正交视图。
:::

平行投影经常被用于机械和建筑图纸中，因为它们能够保持平行线的平行性，并保持平行于图像平面的平面对象的大小和形状不变。

::: center
![](../images/4_4.png)
**Figure 4.4.** 图像平面和投影方向成一定角度的平行投影被称为斜投影（右图）。在透视投影中，所有的投影线都经过视点，而不是平行的（左图）。所示的透视视图是非斜的，因为通过图像中心绘制的投影线垂直于图像平面。
:::

## 4.3 计算视角光线

## 4.4 光线与物体相交

## 4.5 着色

## 4.6 光线追踪程序

## 4.7 阴影

## 4.8 理想的镜面反射

## 4.9 历史记录
